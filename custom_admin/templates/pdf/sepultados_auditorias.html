<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="utf-8">
<title>Relatório de Auditorias</title>

<style>
  /* ----- Página: A4 em paisagem, margem segura (sem moldura) ----- */
  @page {
    size: A4 landscape;
    margin: 1.5cm;
  }

  html, body { margin: 0; padding: 0; }
  body { font-family: Arial, Helvetica, sans-serif; color: #000; }

  /* ----- Cabeçalho (igual ao padrão) ----- */
  .cabecalho { display: flex; align-items: flex-start; gap: 12px; margin-bottom: 6px; }
  .logo img   { max-height: 75px; }
  .dados      { font-size: 11pt; line-height: 1.35; }

  /* ----- Título verde central ----- */
  .titulo { text-align: center; margin: 6px 0 8px; }
  .titulo span { background: #e3efcc; border: 1px solid #000; padding: 4px 10px; display: inline-block; }

  /* ----- Tabela de resumo (caixinhas) ----- */
  table.resumo { width: 100%; border-collapse: collapse; margin: 8px 0 10px; font-size: 10pt; }
  .resumo th, .resumo td { border: 1px solid #000; padding: 3px 6px; white-space: nowrap; text-align: center; }
  .resumo thead th { background: #e3efcc; }

  /* ----- Tabela principal ----- */
  table.tabela { width: 100%; border-collapse: collapse; font-size: 9.6pt; }
  .tabela th, .tabela td { border: 1px solid #000; padding: 4px 6px; vertical-align: top; }
  .tabela thead th { background: #e3efcc; }

  /* Repetir cabeçalho em cada página e evitar cortes esquisitos */
  thead { display: table-header-group; }
  tfoot { display: table-row-group; }
  tr    { page-break-inside: avoid; }

  /* Larguras pensadas pra paisagem */
  .col-data { width: 14%; }
  .col-user { width: 21%; }
  .col-acao { width: 9%;  text-transform: capitalize; }
  .col-ent  { width: 14%; }
  .col-obj  { width: 7%;  text-align: center; }
  .col-det  { width: 35%; overflow-wrap: anywhere; word-break: break-word; }

  .muted { color: #444; font-style: italic; }
</style>
</head>
<body>

<!-- ===== Cabeçalho padrão (brasão + dados) ===== -->
<div class="cabecalho">
  <div class="logo">
    {% if brasao_url %}
      <img src="{{ brasao_url }}" alt="Brasão da Prefeitura">
    {% elif brasao_path %}
      <img src="{{ brasao_path }}" alt="Brasão da Prefeitura">
    {% endif %}
  </div>

  <div class="dados">
    <strong>Prefeitura Municipal de {{ prefeitura.nome }}</strong><br>
    {% if prefeitura.logradouro %}
      {{ prefeitura.logradouro }}{% if prefeitura.endereco_numero %}, {{ prefeitura.endereco_numero }}{% endif %}<br>
    {% endif %}
    {% if prefeitura.endereco_bairro %}{{ prefeitura.endereco_bairro }} – {% endif %}
    {% if prefeitura.endereco_cidade %}{{ prefeitura.endereco_cidade }}{% endif %}
    {% if prefeitura.endereco_estado %} – {{ prefeitura.endereco_estado }}{% endif %}<br>
    {% if prefeitura.endereco_cep %}CEP {{ prefeitura.endereco_cep }}{% endif %}
  </div>
</div>

<div class="titulo"><span>Relatório de Auditorias</span></div>

<!-- ===== Resumo / Filtros ===== -->
<table class="resumo">
  <thead>
    <tr>
      <th>Total</th>
      <th>Criações</th>
      <th>Atualizações</th>
      <th>Exclusões</th>
      <th>Falhas</th>
      <th>Datas</th>
      <th>Ação</th>
      <th>Entidade</th>
      <th>Usuário</th>
      <th>Busca</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <td>{{ total|default:"0" }}</td>
      <td>{{ add|default:"0" }}</td>
      <td>{{ change|default:"0" }}</td>
      <td>{{ delete|default:"0" }}</td>
      <td>{{ fail|default:"0" }}</td>
      <td>
        {% if data_inicio %}{{ data_inicio|date:"d/m/Y" }}{% else %}todas{% endif %}
         — {% if data_fim %}{{ data_fim|date:"d/m/Y" }}{% else %}todas{% endif %}
      </td>
      <td>{{ acao|default:"todas" }}</td>
      <td>{{ entidade|default:"todas" }}</td>
      <td>
        {% if usuario_email %}{{ usuario_email }}
        {% elif usuario_username %}{{ usuario_username }}
        {% elif usuario_nome %}{{ usuario_nome }}
        {% else %}todos{% endif %}
      </td>
      <td>{{ busca|default:"" }}</td>
    </tr>
  </tbody>
</table>

<!-- ===== Tabela de registros ===== -->
<table class="tabela">
  <thead>
    <tr>
      <th class="col-data">Data/Hora</th>
      <th class="col-user">Usuário</th>
      <th class="col-acao">Ação</th>
      <th class="col-ent">Entidade</th>
      <th class="col-obj">Objeto</th>
      <th class="col-det">Detalhes</th>
    </tr>
  </thead>
  <tbody>
  {% for r in linhas %}
    <tr>
      <td class="col-data">{{ r.data_hora|date:"d/m/Y, H:i" }}</td>

      <td class="col-user">
        {% if r.usuario_email %}{{ r.usuario_email }}
        {% elif r.usuario_username %}{{ r.usuario_username }}
        {% elif r.usuario_nome %}{{ r.usuario_nome }}
        {% else %}-{% endif %}
      </td>

      <td class="col-acao">
        {# usa label se vier do backend; senão traduz o raw #}
        {% if r.acao_label %}{{ r.acao_label }}
        {% else %}
          {% with a=r.acao|lower %}
            {% if a in "add,adição,adicao,create,criação,criacao" %}Adição
            {% elif a in "change,edição,edicao,update" %}Edição
            {% elif a in "delete,exclusão,exclusao" %}Exclusão
            {% elif a in "fail,falha,erro,error" %}Falha
            {% else %}{{ r.acao }}{% endif %}
          {% endwith %}
        {% endif %}
      </td>

      <td class="col-ent">{{ r.modelo|default:"-" }}</td>
      <td class="col-obj">{{ r.objeto_id|default:"-" }}</td>
      <td class="col-det">{{ r.detalhes|default:"-" }}</td>
    </tr>
  {% empty %}
    <tr>
      <td colspan="6" class="muted">Nenhum registro com os filtros atuais.</td>
    </tr>
  {% endfor %}
  </tbody>
</table>

</body>
</html>
